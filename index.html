<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google Consent Mode v2 -->
    <script>
      window.dataLayer = window.dataLayer || [];

      // Store the original gtag function for development mode
      const originalGtag = function () {
        dataLayer.push(arguments);
      };

      // Set up gtag globally
      window.gtag = originalGtag;

      // Check if we're in development mode
      window.GA_MEASUREMENT_ID = "__GA_MEASUREMENT_ID__";
      window.isProduction = window.GA_MEASUREMENT_ID !== "GA-DEVELOPMENT-MODE";
      window.isDevelopment = !window.isProduction;

      if (window.isDevelopment) {
        // Development mode - log analytics calls instead of sending them
        console.log(
          "🔧 Development mode: Google Analytics calls will be logged to console"
        );
        window.gtag_dev_mode = true;

        // Override gtag function for development with proper delegation
        window.gtag = function () {
          console.log("📊 GA (dev):", Array.from(arguments));
          // Always call the original function for consent mode functionality
          return originalGtag.apply(this, arguments);
        };
      }

      // Default consent state (GDPR compliant - all optional cookies denied by default)
      gtag("consent", "default", {
        analytics_storage: "denied",
        ad_storage: "denied",
        ad_user_data: "denied",
        ad_personalization: "denied",
        functionality_storage: "granted",
        security_storage: "granted",
      });

      // Load Google Analytics
      gtag("js", new Date());
    </script>
    <!-- Google Analytics (only load in production) -->
    <script>
      if (window.isProduction) {
        // Production: Load Google Analytics normally
        const script = document.createElement("script");
        script.async = true;
        script.src = `https://www.googletagmanager.com/gtag/js?id=${window.GA_MEASUREMENT_ID}`;

        // Add error handling
        script.onerror = () => {
          console.warn("⚠️ Failed to load Google Analytics script");
        };

        script.onload = () => {
          // In production, the real gtag function will be available
          // No need to override - the external script provides the real gtag
          gtag("config", window.GA_MEASUREMENT_ID, {
            anonymize_ip: true,
            cookie_flags: "SameSite=None;Secure",
          });
          console.log("✅ Google Analytics loaded successfully");
        };

        document.head.appendChild(script);
      } else {
        // Development: Skip loading GA script
        console.log(
          "🔧 Development mode: Skipping Google Analytics script load"
        );
        // Still configure for testing consent functionality
        gtag("config", "GA-DEVELOPMENT-MODE", {
          anonymize_ip: true,
          cookie_flags: "SameSite=None;Secure",
        });
      }
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Light of Data</title>
    <link
      rel="icon"
      type="image/png"
      href="/images/small/png/logo-small-light-t.png"
    />
    <link rel="stylesheet" href="/src/style.css" />

    <script>
      // Dark mode toggle logic
      const updateGithubIcon = (theme) => {
        const icon = document.getElementById("github-icon");
        if (!icon) return;
        icon.src =
          theme === "dark"
            ? "/images/github-mark-white.svg"
            : "/images/github-mark.svg";
      };
      const updateLinkedInIcon = (theme) => {
        const icon = document.getElementById("linkedin-icon");
        if (!icon) return;
        icon.src =
          theme === "dark"
            ? "/images/InBug-White.png"
            : "/images/InBug-Black.png";
      };
      const updateHeadIcon = (theme) => {
        let link = document.querySelector("link[rel~='icon']");
        if (!link) {
          link = document.createElement("link");
          link.rel = "icon";
          document.getElementsByTagName("head")[0].appendChild(link);
        }
        link.href =
          theme === "dark"
            ? "/images/small/png/logo-small-light-t.png?v=dark"
            : "/images/small/png/logo-small-dark-t.png?v=light";
      };
      const setTheme = (theme, manual = false) => {
        document.documentElement.setAttribute("data-theme", theme);
        updateGithubIcon(theme);
        updateLinkedInIcon(theme);
        if (!manual) updateHeadIcon(theme);
      };
      const toggleTheme = () => {
        const current = document.documentElement.getAttribute("data-theme");
        setTheme(current === "dark" ? "light" : "dark", true);
      };
      // On load, set theme from system and update icons after DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        const systemDark = window.matchMedia("(prefers-color-scheme: dark)");
        setTheme(systemDark.matches ? "dark" : "light");
        // Listen for system theme changes if user hasn't chosen manually
        systemDark.addEventListener("change", (e) => {
          setTheme(e.matches ? "dark" : "light");
        });
        // Mobile menu toggle
        const menuToggle = document.getElementById("menu-toggle");
        const navLinks = document.getElementById("nav-links");

        // Toggle menu when hamburger is clicked
        menuToggle.addEventListener("click", () => {
          navLinks.classList.toggle("open");
          menuToggle.classList.toggle("active");
        });

        // Close menu when any navigation link is clicked
        const MENU_CLOSE_DELAY = 250; // ms
        const navLinkItems = navLinks.querySelectorAll("li a");
        const navHeight = document.querySelector("nav").offsetHeight || 60;
        navLinkItems.forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();

            // Close the menu immediately
            navLinks.classList.remove("open");
            menuToggle.classList.remove("active");

            // Get target and scroll smoothly after menu closes
            const targetId = link.getAttribute("href");
            const targetElement = document.querySelector(targetId);

            if (targetElement) {
              setTimeout(() => {
                const targetTop = targetElement.offsetTop - navHeight - 10;

                window.scrollTo({
                  top: Math.max(0, targetTop),
                  behavior: "smooth",
                });
              }, MENU_CLOSE_DELAY); // Wait for menu close animation
            }
          });
        });

        // Handle logo click separately (no menu closing needed)
        const logoLink = document.querySelector(".logo a");
        if (logoLink) {
          logoLink.addEventListener("click", (e) => {
            e.preventDefault();
            window.scrollTo({
              top: 0,
              behavior: "smooth",
            });
          });
        }

        // Cookie Consent Management
        const COOKIE_CONSENT_KEY = "cookie-consent-preferences";
        const COOKIE_CONSENT_VERSION = "1.0";
        const COOKIE_DIALOG_SHOW_DELAY = 500; // ms

        // Check if user has already given consent
        const hasValidConsent = () => {
          try {
            const stored = localStorage.getItem(COOKIE_CONSENT_KEY);
            if (!stored) return false;

            const preferences = JSON.parse(stored);
            return (
              preferences.version === COOKIE_CONSENT_VERSION &&
              preferences.timestamp
            );
          } catch (e) {
            return false;
          }
        };

        // Get stored consent preferences
        const getConsentPreferences = () => {
          try {
            const stored = localStorage.getItem(COOKIE_CONSENT_KEY);
            if (!stored) return null;

            const preferences = JSON.parse(stored);
            if (preferences.version !== COOKIE_CONSENT_VERSION) return null;

            return preferences;
          } catch (e) {
            return null;
          }
        };

        // Save consent preferences
        const saveConsentPreferences = (analytics, marketing) => {
          const preferences = {
            version: COOKIE_CONSENT_VERSION,
            timestamp: Date.now(),
            analytics: analytics,
            marketing: marketing,
            essential: true, // Always true
          };

          try {
            localStorage.setItem(
              COOKIE_CONSENT_KEY,
              JSON.stringify(preferences)
            );
            return preferences;
          } catch (e) {
            console.warn("⚠️ Failed to save cookie preferences:", e.message);
            return preferences; // Return preferences even if storage fails
          }
        };

        // Update Google Consent Mode
        const updateGoogleConsent = (analytics, marketing) => {
          if (typeof gtag === "function") {
            gtag("consent", "update", {
              analytics_storage: analytics ? "granted" : "denied",
              ad_storage: marketing ? "granted" : "denied",
              ad_user_data: marketing ? "granted" : "denied",
              ad_personalization: marketing ? "granted" : "denied",
            });
          }
        };

        // Show cookie consent dialog
        const showCookieDialog = () => {
          const overlay = document.getElementById("cookie-consent-overlay");
          if (overlay) {
            // Ensure checkboxes reflect current stored preferences
            applyStoredConsent();

            overlay.classList.add("show");

            // Focus management for accessibility
            const firstButton = overlay.querySelector(
              'button, input[type="checkbox"]'
            );
            if (firstButton) {
              firstButton.focus();
            }
          }
        };

        // Update checkbox UI states
        const updateCheckboxes = (analytics, marketing) => {
          const analyticsCheckbox =
            document.getElementById("analytics-consent");
          const marketingCheckbox =
            document.getElementById("marketing-consent");

          if (analyticsCheckbox) analyticsCheckbox.checked = analytics;
          if (marketingCheckbox) marketingCheckbox.checked = marketing;
        };

        // Hide cookie consent dialog
        const hideCookieDialog = () => {
          const overlay = document.getElementById("cookie-consent-overlay");
          if (overlay) {
            overlay.classList.remove("show");
          }
        };

        // Apply stored consent on page load
        const applyStoredConsent = () => {
          const preferences = getConsentPreferences();
          if (preferences) {
            updateGoogleConsent(preferences.analytics, preferences.marketing);
            // Update UI checkboxes to match stored preferences
            updateCheckboxes(preferences.analytics, preferences.marketing);
          } else {
            // No stored preferences - ensure UI reflects GDPR compliant default state (all optional cookies off)
            updateCheckboxes(false, false);
          }
        };

        // Handle consent choices
        const handleConsentChoice = (analytics, marketing) => {
          const preferences = saveConsentPreferences(analytics, marketing);
          updateGoogleConsent(analytics, marketing);
          hideCookieDialog();

          // Optional: Show confirmation message
          console.log("Cookie preferences saved:", preferences);
        };

        // Initialize cookie consent functionality
        const initCookieConsent = () => {
          // Apply any stored consent
          applyStoredConsent();

          // Show dialog if no valid consent exists
          if (!hasValidConsent()) {
            // Show dialog after a short delay to ensure page is loaded
            setTimeout(showCookieDialog, COOKIE_DIALOG_SHOW_DELAY);
          }

          // Event listeners
          const acceptAllBtn = document.getElementById("cookie-accept-all");
          const acceptSelectedBtn = document.getElementById(
            "cookie-accept-selected"
          );
          const rejectAllBtn = document.getElementById("cookie-reject-all");
          const closeBtn = document.getElementById("cookie-consent-close");
          const preferencesBtn = document.getElementById(
            "cookie-preferences-btn"
          );
          const overlay = document.getElementById("cookie-consent-overlay");

          if (acceptAllBtn) {
            acceptAllBtn.addEventListener("click", () => {
              // Update checkboxes to reflect "Accept All" choice
              updateCheckboxes(true, true);
              handleConsentChoice(true, true);
            });
          }

          if (acceptSelectedBtn) {
            acceptSelectedBtn.addEventListener("click", () => {
              const analyticsCheckbox =
                document.getElementById("analytics-consent");
              const marketingCheckbox =
                document.getElementById("marketing-consent");

              const analytics = analyticsCheckbox
                ? analyticsCheckbox.checked
                : false;
              const marketing = marketingCheckbox
                ? marketingCheckbox.checked
                : false;

              handleConsentChoice(analytics, marketing);
            });
          }

          if (rejectAllBtn) {
            rejectAllBtn.addEventListener("click", () => {
              // Update checkboxes to reflect "Reject All" choice
              updateCheckboxes(false, false);
              handleConsentChoice(false, false);
            });
          }

          if (closeBtn) {
            closeBtn.addEventListener("click", hideCookieDialog);
          }

          if (preferencesBtn) {
            preferencesBtn.addEventListener("click", showCookieDialog);
          }

          // Close dialog when clicking outside
          if (overlay) {
            overlay.addEventListener("click", (e) => {
              if (e.target === overlay) {
                hideCookieDialog();
              }
            });
          }

          // Keyboard accessibility
          document.addEventListener("keydown", (e) => {
            if (
              e.key === "Escape" &&
              overlay &&
              overlay.classList.contains("show")
            ) {
              hideCookieDialog();
            }
          });
        };

        // Initialize cookie consent when DOM is ready
        initCookieConsent();
      });
    </script>
  </head>
  <body>
    <nav>
      <div class="container">
        <div class="logo">
          <a
            href="#home"
            style="text-decoration: none; display: flex; align-items: center"
          >
            <img
              src="/images/small/png/logo-small-light-t.png"
              alt="Light of Data logo"
              style="height: 40px; width: auto; vertical-align: middle"
            />
          </a>
        </div>
        <button class="menu-toggle" id="menu-toggle" aria-label="Toggle menu">
          <span class="menu-icon">&#9776;</span>
        </button>
        <ul class="nav-links" id="nav-links">
          <li><a href="#home">Home</a></li>
          <li><a href="#about-title">About</a></li>
          <li><a href="#services-title">Services</a></li>
          <li><a href="#contact-title">Contact</a></li>
        </ul>
        <button
          id="theme-toggle"
          onclick="toggleTheme()"
          style="
            margin-left: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            background: #1a6a7e;
            color: #222;
            font-weight: 600;
          "
        >
          🌓
        </button>
      </div>
    </nav>

    <section class="hero" id="home">
      <h1>
        <img
          src="/images/large/png/logo-large-light-t.png"
          alt="Light of Data logo"
          style="height: 60px; width: auto; vertical-align: middle"
        />
      </h1>
      <p>
        Machine learning engineering and software development for a better
        world.
      </p>
    </section>

    <section class="section" id="about">
      <h2 id="about-title">About Us</h2>
      <p>
        Light of Data is dedicated to empowering organizations with cutting-edge
        software development and machine learning engineering. We focus on
        creating solutions that drive progress in climate change mitigation,
        renewable energy, sustainability, AI governance, and health-advancing
        technology for a better future.
      </p>
    </section>

    <section class="section" id="services">
      <h2 id="services-title">Our Services</h2>
      <div class="services">
        <div class="service">
          <h3>Coding & Prototyping</h3>
          <p>Rapid development of proof-of-concepts and prototypes.</p>
          <p>Clean, efficient, and scalable code tailored to your needs.</p>
          <p>Support across multiple programming languages and frameworks.</p>
        </div>
        <div class="service">
          <h3>Software Development</h3>
          <p>
            End-to-end design and implementation of applications, APIs, and
            platforms.
          </p>
          <p>Integration of data pipelines and AI models.</p>
          <p>Robust, maintainable, and secure software solutions.</p>
        </div>
        <div class="service">
          <h3>Consulting</h3>
          <p>
            Guidance on machine learning strategy, data infrastructure, and AI
            governance.
          </p>
          <p>Technical audits and architecture reviews.</p>
        </div>
        <div class="service">
          <h3>Training & Knowledge Transfer</h3>
          <p>
            Hands-on workshops in machine learning and modern software
            practices.
          </p>
          <p>Customized training for technical teams.</p>
          <p>
            Empowering your organization to build and maintain in-house
            expertise.
          </p>
        </div>
      </div>
    </section>

    <section class="section" id="contact">
      <h2 id="contact-title">Contact & Links</h2>
      <div class="contact-links-row">
        <div class="contact-col">
          <h3>Email</h3>
          <a href="mailto:info@lightofdata.earth" class="contact-email"
            >info@lightofdata.earth</a
          >
        </div>
        <div class="links-col">
          <h3>Links</h3>
          <div class="contact-socials">
            <a
              href="https://linkedin.com/company/lightofdata"
              target="_blank"
              rel="noopener"
              aria-label="LinkedIn"
            >
              <img
                src="/images/LI-In-Bug.png"
                id="linkedin-icon"
                alt="LinkedIn"
                style="
                  height: 28px;
                  width: 28px;
                  vertical-align: middle;
                  margin: 0 0.5rem;
                "
              />
            </a>
            <a
              href="https://github.com/lightofdata"
              target="_blank"
              rel="noopener"
              aria-label="GitHub"
            >
              <img
                src="/images/github-mark.svg"
                id="github-icon"
                alt="GitHub"
                style="
                  height: 28px;
                  width: 28px;
                  vertical-align: middle;
                  margin: 0 0.5rem;
                "
              />
            </a>
          </div>
        </div>
      </div>
    </section>

    <footer class="footer">
      <div class="footer-content">
        <span>© 2025 Light Of Data Ltd</span> |
        <span>Company #: 14811585</span> | <span>VAT #: GB438798236</span> |
        <span>
          <button
            id="cookie-preferences-btn"
            class="cookie-preferences-btn"
            aria-label="Manage Cookie Preferences"
          >
            Cookie Preferences
          </button>
        </span>
      </div>
    </footer>

    <!-- Cookie Consent Dialog -->
    <div
      id="cookie-consent-overlay"
      class="cookie-consent-overlay"
      role="dialog"
      aria-labelledby="cookie-consent-title"
      aria-describedby="cookie-consent-description"
      aria-modal="true"
    >
      <div class="cookie-consent-dialog">
        <div class="cookie-consent-header">
          <h2 id="cookie-consent-title">Cookie Preferences</h2>
          <button
            id="cookie-consent-close"
            class="cookie-consent-close"
            aria-label="Close cookie preferences"
          >
            ×
          </button>
        </div>

        <div class="cookie-consent-content">
          <p id="cookie-consent-description">
            We use cookies to enhance your browsing experience and analyze our
            website traffic.
            <strong>Optional cookies are disabled by default</strong> in
            compliance with GDPR. Please select which cookies you would like to
            enable below.
          </p>

          <div class="cookie-categories">
            <div class="cookie-category">
              <div class="cookie-category-header">
                <h3>Essential Cookies</h3>
                <span class="cookie-status">Always Active</span>
              </div>
              <p class="cookie-description">
                These cookies are necessary for the website to function and
                cannot be switched off. They are usually only set in response to
                actions made by you.
              </p>
            </div>

            <div class="cookie-category">
              <div class="cookie-category-header">
                <h3>Analytics Cookies</h3>
                <label class="cookie-toggle">
                  <input
                    type="checkbox"
                    id="analytics-consent"
                    name="analytics"
                  />
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <p class="cookie-description">
                These cookies help us understand how visitors interact with our
                website by collecting and reporting information anonymously.
              </p>
            </div>

            <div class="cookie-category">
              <div class="cookie-category-header">
                <h3>Marketing Cookies</h3>
                <label class="cookie-toggle">
                  <input
                    type="checkbox"
                    id="marketing-consent"
                    name="marketing"
                  />
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <p class="cookie-description">
                These cookies are used to track visitors across websites to
                display relevant advertisements and measure campaign
                effectiveness.
              </p>
            </div>
          </div>
        </div>

        <div class="cookie-consent-footer">
          <button id="cookie-accept-all" class="cookie-btn cookie-btn-primary">
            Accept All
          </button>
          <button
            id="cookie-accept-selected"
            class="cookie-btn cookie-btn-secondary"
          >
            Accept Selected
          </button>
          <button id="cookie-reject-all" class="cookie-btn cookie-btn-outline">
            Reject All
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
